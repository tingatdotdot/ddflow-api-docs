openapi: 3.1.0
info:
  title: ddflow ALPHA Webhook API
  version: 1.2.0
  description: |
    ## ddflow Webhook 端點 (接收 ALPHA 通知)

    此文件定義 ddflow 系統提供給 ALPHA 呼叫的 Webhook 端點。
    當 LINE 確認完成、逾時或額度變更時，ALPHA 系統會呼叫這些端點通知 ddflow。

    ### Webhook 類型
    - **確認通知 (Confirmation)**: LINE 推播授權確認完成時發送
    - **逾時通知 (Timeout)**: LINE 確認逾時時發送
    - **額度變更通知 (Quota Change)**: 客戶額度變更時發送

    ### Event Types
    建議 Webhook 請求包含 `event_type` 欄位以便識別事件類型：
    - `order.confirmed` - 訂單已確認
    - `order.timeout` - 訂單確認逾時
    - `quota.changed` - 額度變更

    ### Base URL
    - Production: `https://platform.ddflow.money/api`
    - Staging: `https://staging.ddflow.money/api`

servers:
  - url: https://platform.ddflow.money/api
    description: ddflow Production Server
  - url: https://staging.ddflow.money/api
    description: ddflow Staging Server

paths:
  /webhooks/alpha/confirmation:
    post:
      operationId: handleConfirmation
      summary: LINE 確認通知
      description: |
        當 AuthUser 透過 LINE 確認薪資墊付申請後，ALPHA 系統呼叫此端點通知 ddflow。

        ### 觸發時機
        - 用戶在 LINE 上點擊確認按鈕
        - LINE 推播授權流程完成

        ### ddflow 處理流程
        1. 更新 PayrollLoan 狀態為 `confirmed`
        2. 發送 VAC 付款指示郵件
        3. 等待 VAC 入款通知

      tags:
        - ALPHA Webhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfirmationRequest'
            examples:
              standard:
                summary: 標準確認通知
                value:
                  event_type: "order.confirmed"
                  order_code: "PL20241201ABCD1234"
                  customer_id: "CUS-2024-001"
                  status: "confirmed"
                  confirmed_at: "2024-12-01T14:30:00+08:00"
              simulation:
                summary: 模擬確認（測試用）
                value:
                  event_type: "order.confirmed"
                  order_code: "PL20241201ABCD1234"
                  customer_id: "CUS-2024-001"
                  status: "confirmed"
                  confirmed_at: "2024-12-01T14:30:00+08:00"
                  simulation: true
      responses:
        '200':
          description: 確認通知處理成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              example:
                success: true
                message: "Confirmation processed"
        '422':
          description: 請求參數驗證失敗
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
              example:
                message: "The order_code field is required."
                errors:
                  order_code:
                    - "The order_code field is required."
        '500':
          description: 處理失敗
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: "Processing failed"

  /webhooks/alpha/timeout:
    post:
      operationId: handleTimeout
      summary: LINE 確認逾時通知
      description: |
        當 LINE 確認等待逾時時，ALPHA 系統呼叫此端點通知 ddflow。

        ### 觸發時機
        - LINE 推播授權等待超過設定時間
        - 用戶未在時限內完成確認

        ### ddflow 處理流程
        1. 更新 PayrollLoan 狀態為 `timeout`
        2. 通知 AIBOU 系統逾時
        3. 可透過 retry 端點重新發起流程

      tags:
        - ALPHA Webhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TimeoutRequest'
            example:
              event_type: "order.timeout"
              order_code: "PL20241201EFGH5678"
              customer_id: "CUS-2024-001"
              timeout_at: "2024-12-01T15:00:00+08:00"
      responses:
        '200':
          description: 逾時通知處理成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              example:
                success: true
                message: "Timeout processed"
        '422':
          description: 請求參數驗證失敗
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
              example:
                message: "The timeout_at field is required."
                errors:
                  timeout_at:
                    - "The timeout_at field is required."
        '500':
          description: 處理失敗
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: "Processing failed"

  /webhooks/alpha/retry:
    post:
      operationId: retryLoan
      summary: 重試薪資墊付流程
      description: |
        對已逾時的訂單重新發起薪資墊付流程。

        ### 使用情境
        - 訂單狀態為 `timeout` 且未超過最大重試次數
        - 需要重新發起 LINE 確認流程

        ### 限制
        - 最大重試次數：3 次
        - 僅 `timeout` 狀態的訂單可重試

      tags:
        - ALPHA Webhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RetryRequest'
            example:
              order_code: "PL20241201EFGH5678"
      responses:
        '200':
          description: 重試已啟動
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              example:
                success: true
                message: "Retry initiated"
        '400':
          description: 無法重試（已達最大次數或狀態不符）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RetryErrorResponse'
              example:
                success: false
                error: "Cannot retry this loan"
                status: "disbursed"
                retry_count: 3
        '404':
          description: 訂單不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: "Order not found"

  /webhooks/alpha/quota-change:
    post:
      operationId: handleQuotaChange
      summary: 額度變更通知
      description: |
        當客戶額度發生變更時，ALPHA 系統呼叫此端點通知 ddflow。
        ddflow 會儲存最新的額度資訊以供查詢。

        ### 觸發時機
        - 客戶額度核准或調整
        - 額度核銷或退款完成
        - 額度圈存或釋放

        ### ddflow 處理流程
        1. 更新或建立 CustomerQuota 記錄
        2. 記錄額度變更歷史

      tags:
        - ALPHA Webhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QuotaChangeRequest'
            examples:
              quota_approved:
                summary: 額度核准
                value:
                  event_type: "quota.changed"
                  customer_id: "CUS-2024-001"
                  customer_name: "測試企業股份有限公司"
                  approved_amount: 5000000
                  captured_amount: 0
                  available_amount: 5000000
                  reserved_amount: 0
                  changed_at: "2024-12-01T10:00:00+08:00"
                  change_reason: "額度核准"
              quota_captured:
                summary: 額度已核銷
                value:
                  event_type: "quota.changed"
                  customer_id: "CUS-2024-001"
                  customer_name: "測試企業股份有限公司"
                  approved_amount: 5000000
                  captured_amount: 150000
                  available_amount: 4850000
                  reserved_amount: 0
                  changed_at: "2024-12-01T15:30:00+08:00"
                  change_reason: "訂單 PL20241201ABCD1234 核銷"
      responses:
        '200':
          description: 額度變更通知處理成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuotaChangeResponse'
              example:
                success: true
                message: "Quota updated"
                data:
                  customer_id: "CUS-2024-001"
                  approved_amount: 5000000
                  available_amount: 4850000
                  last_synced_at: "2024-12-01T15:30:00+08:00"
        '422':
          description: 請求參數驗證失敗
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
              example:
                message: "The customer_id field is required."
                errors:
                  customer_id:
                    - "The customer_id field is required."
        '500':
          description: 處理失敗
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: "Processing failed"

components:
  schemas:
    ConfirmationRequest:
      type: object
      required:
        - order_code
        - customer_id
      properties:
        event_type:
          type: string
          description: |
            事件類型（建議提供）
          enum:
            - order.confirmed
          example: "order.confirmed"
        order_code:
          type: string
          description: 訂單編號
          example: "PL20241201ABCD1234"
        customer_id:
          type: string
          description: 商家代碼 (Headquarter UID)
          example: "CUS-2024-001"
        status:
          type: string
          description: 訂單狀態
          enum:
            - confirmed
          example: "confirmed"
        confirmed_at:
          type: string
          format: date-time
          description: 確認時間 (ISO 8601 格式)
          example: "2024-12-01T14:30:00+08:00"
        simulation:
          type: boolean
          description: 是否為模擬請求（測試用）
          default: false
          example: false

    TimeoutRequest:
      type: object
      required:
        - order_code
        - customer_id
        - timeout_at
      properties:
        event_type:
          type: string
          description: |
            事件類型（建議提供）
          enum:
            - order.timeout
          example: "order.timeout"
        order_code:
          type: string
          description: 訂單編號
          example: "PL20241201EFGH5678"
        customer_id:
          type: string
          description: 商家代碼 (Headquarter UID)
          example: "CUS-2024-001"
        timeout_at:
          type: string
          format: date-time
          description: 逾時時間 (ISO 8601 格式)
          example: "2024-12-01T15:00:00+08:00"

    RetryRequest:
      type: object
      required:
        - order_code
      properties:
        order_code:
          type: string
          description: 訂單編號
          example: "PL20241201EFGH5678"

    QuotaChangeRequest:
      type: object
      required:
        - customer_id
        - approved_amount
      properties:
        event_type:
          type: string
          description: 事件類型
          enum:
            - quota.changed
          example: "quota.changed"
        customer_id:
          type: string
          description: 商家代碼 (Headquarter UID)
          example: "CUS-2024-001"
        customer_name:
          type: string
          description: 商家名稱
          example: "測試企業股份有限公司"
        approved_amount:
          type: integer
          description: 核准額度（總額）
          minimum: 0
          example: 5000000
        captured_amount:
          type: integer
          description: 已核銷金額
          minimum: 0
          example: 150000
        available_amount:
          type: integer
          description: 可用額度
          minimum: 0
          example: 4850000
        reserved_amount:
          type: integer
          description: 圈存中金額
          minimum: 0
          example: 0
        changed_at:
          type: string
          format: date-time
          description: 變更時間 (ISO 8601 格式)
          example: "2024-12-01T15:30:00+08:00"
        change_reason:
          type: string
          description: 變更原因說明
          example: "訂單 PL20241201ABCD1234 核銷"

    QuotaChangeResponse:
      type: object
      required:
        - success
        - message
      properties:
        success:
          type: boolean
          description: 是否成功
          example: true
        message:
          type: string
          description: 回應訊息
          example: "Quota updated"
        data:
          type: object
          properties:
            customer_id:
              type: string
              description: 商家代碼
              example: "CUS-2024-001"
            approved_amount:
              type: integer
              description: 核准額度
              example: 5000000
            available_amount:
              type: integer
              description: 可用額度
              example: 4850000
            last_synced_at:
              type: string
              format: date-time
              description: 最後同步時間
              example: "2024-12-01T15:30:00+08:00"

    SuccessResponse:
      type: object
      required:
        - success
        - message
      properties:
        success:
          type: boolean
          description: 是否成功
          example: true
        message:
          type: string
          description: 回應訊息
          example: "Confirmation processed"

    ErrorResponse:
      type: object
      required:
        - success
        - error
      properties:
        success:
          type: boolean
          description: 是否成功（固定為 false）
          example: false
        error:
          type: string
          description: 錯誤訊息
          example: "Processing failed"

    RetryErrorResponse:
      type: object
      required:
        - success
        - error
      properties:
        success:
          type: boolean
          description: 是否成功（固定為 false）
          example: false
        error:
          type: string
          description: 錯誤訊息
          example: "Cannot retry this loan"
        status:
          type: string
          description: 目前訂單狀態
          example: "disbursed"
        retry_count:
          type: integer
          description: 目前重試次數
          example: 3

    ValidationErrorResponse:
      type: object
      required:
        - message
        - errors
      properties:
        message:
          type: string
          description: 驗證錯誤摘要
          example: "The order_code field is required."
        errors:
          type: object
          description: 各欄位的驗證錯誤
          additionalProperties:
            type: array
            items:
              type: string
          example:
            order_code:
              - "The order_code field is required."

tags:
  - name: ALPHA Webhook
    description: ALPHA 系統呼叫 ddflow 的 Webhook 端點
